# Blockchain.py - ルールと検証のまとめ

## 定数による共通ルール
- `POW_DIFFICULTY = 10` : Proof of Workの難易度（ハッシュ末尾の0の数）
- `REWARD_AMOUNT = 256` : マイニング報酬の金額（固定）

---

## 各関数のルールと検証内容

### 1. `verify_transaction(transaction)` - トランザクション検証
**役割**: 個別のトランザクションが正当かチェック

**検証ルール**:
- ✅ **金額チェック** (45-46行目)
  - `amount`が0以下の場合は拒否
  
- ✅ **署名検証** (47-59行目)
  - 送信者の公開鍵で署名を検証
  - 署名が不正な場合は拒否（BadSignatureError）
  - トランザクションの改ざんを防ぐ

---

### 2. `add_transaction(transaction)` - トランザクション追加
**役割**: トランザクションプールへの追加

**検証ルール**:
- ✅ **verify_transaction()を呼び出し** (38行目)
  - 検証に合格したトランザクションのみプールに追加

---

### 3. `verify_chain(chain)` - チェーン全体の検証
**役割**: ブロックチェーン全体が正当かチェック（最も重要な関数）

**検証ルール**:

#### ブロックレベルの検証
- ✅ **ジェネシスブロック検証** (89-91行目)
  - 最初のブロックは`first_block`と完全一致する必要がある
  
- ✅ **ハッシュチェーン検証** (93-95行目)
  - 各ブロックの`hash`が前のブロックのハッシュ値と一致
  
- ✅ **Proof of Work検証** (97-108行目)
  - ブロックハッシュの末尾が指定された数の0で終わっているか
  - `POW_DIFFICULTY`の値に応じた難易度を満たしているか

#### トランザクションレベルの検証
- ✅ **マイニング報酬の検証** (110-118行目)
  - 各ブロックに報酬トランザクションは1つまで
  - 送信者が"Blockchain"のトランザクション
  - 報酬金額が`REWARD_AMOUNT`と完全一致
  
- ✅ **通常トランザクションの署名検証** (119-121行目)
  - `verify_transaction()`で各トランザクションを検証
  
- ✅ **二重支払い防止** (122-125行目)
  - 同じトランザクションが複数回含まれていないか
  
- ✅ **残高チェック** (126-128行目)
  - すべてのアカウントの残高が負にならないか
  - `account_calc()`を使用して検証

---

### 4. `create_new_block(miner)` - 新規ブロック作成
**役割**: マイニングによる新規ブロック生成

**適用ルール**:
- 📝 **報酬トランザクション生成** (136-142行目)
  - 送信者: "Blockchain"（固定）
  - 受信者: マイナーのアドレス
  - 金額: `REWARD_AMOUNT`（固定）
  - 署名: "none"（報酬は署名不要）
  
- 📝 **Proof of Work実行** (151-153行目)
  - `nonce`を増やしながらハッシュ計算
  - 末尾が`POW_DIFFICULTY`個の0になるまで繰り返す

---

### 5. `account_calc(transactions)` - 残高計算
**役割**: トランザクションリストから各アカウントの残高を計算

**計算ルール**:
- 📊 **送信者の残高減算** (168-172行目)
  - "Blockchain"以外の送信者から金額を引く
  
- 📊 **受信者の残高加算** (174-177行目)
  - すべての受信者に金額を足す

---

### 6. `replace_chain(chain)` - チェーン置換
**役割**: より長い正当なチェーンで置き換え

**処理内容**:
- 🔄 既存のチェーンを新しいチェーンで置換
- 🔄 すでに含まれているトランザクションをプールから削除

---

## ルール違反となる主なケース

1. **金額の改ざん**
   - 0以下の金額のトランザクション
   - `REWARD_AMOUNT`と異なる報酬金額

2. **署名の不正**
   - 他人になりすましたトランザクション
   - トランザクション内容の改ざん

3. **ブロックの改ざん**
   - ハッシュチェーンの不整合
   - Proof of Workを満たさないブロック

4. **二重支払い**
   - 同じトランザクションを複数回実行
   - 残高以上の送金

5. **マイニングルール違反**
   - 1ブロックに複数の報酬トランザクション
   - 報酬金額の不正な変更

---

## セキュリティのポイント

- **改ざん防止**: ハッシュチェーンと署名検証
- **二重支払い防止**: トランザクションの重複チェック
- **不正マイニング防止**: 報酬金額と回数の制限
- **51%攻撃対策**: より長いチェーンを採用するルール 